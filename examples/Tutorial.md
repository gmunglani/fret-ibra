# Tutorial
The acceptor and donor image stacks should first be visualised in a package like ImageJ to extract parameters like the range of frames of interest, region of interest, bit-depth, resolution, and the presence of outliers. There parameters can be then set in the config file (.cfg) which also includes the path to the image stack files and multiple other options for each module. A log file is generated with details on the input parameters after each module run.

The *Config_tutorial.cfg* file in /examples is used to demonstrate the functionality of this toolkit. Before processing, the donor and acceptor channel image stacks should be renamed in the following format
```txt
Acceptor *file_identifier*_acceptor.tiff
Donor    *file_idenfitier*_donor.tiff
```
First, the *input_path* (**absolute path**) and *filename* parameters needs to be set.
```txt
input_path = ./examples/stack 
filename = Test
```

The range of frames to be processed is then set with the parameter *continuous_range*. If individual frames are desired, then the *manual_frames* parameter is set with comma-separated values. *continuous_range* is only functional when the first frame entry in *manual_frames* is set to 0.
```txt
continuous_range = 1:6
manual_frames = 0
```

## Background subtraction
The user then has the option to run one of three modules. The *background* subtraction module should be run first.
```txt
background = 1
ratio = 0
bleach = 0
```

The background module parameters include the *window* (or tile) size (in pixels) to divide the frame into smaller parts and the acceptor and donor channel *eps* values for the DBSCAN clustering algorithm.

Note, that the higher the *eps* value, the more foreground pixels are included. The two channels can be processed separately, by simply setting the *eps* value to 0 for the other channel.
```txt
window = 40
acceptor_eps = 0.01
donor_eps = 0.01 
```

The background subtraction module can then be run with multiple options including an output HDF5 file (-s) (necessary for further processing), a video animation of per-frame metrics (-a) and a TIFF output file (-t). Option (-e) indicates that all output options are switched on.
```bash
ibra -c Config_tutorial.cfg -a -t -s -v
```
Once this module is run, the video animation can be used to optimize the *eps* values visually. As a general rule of thumb, the lower the *eps* value, the better the background subtraction. *eps* values that are too low to create a cluster will be listed in the log file. 

## Ratiometric processing
Once both donor and acceptor channels have been processed, the *ratio* processing module should be run. The options include cropping (*crop*) the original image (by the top left and bottom right comma-separated coordinates) to the region of interest to speed up processing time. The default for *crop* is (0,0,0,0), which indicates that it is not functional. Furthermore, the *bit_depth* must be set to either 8, 12, or 16. This module also includes boolean parameters for image registration (*register*) and overlap correction (*union*). 
```txt
crop = 0,0,0,0
bit_depth = 12
register = 1
union = 1
```

The ratiometric processing module can then be run after *background* is set to 0, and *ratio* to 1. This generates two graphics, which can be used along with the per-frame metrics animated video generated by the background subtraction module to assess if the *eps* value must be redefined for specific frames.

### Number of foreground pixels (non-zero intensity) per frame
![Pixel Count](images/Test_pixelcount.png)

### Median intensity of foreground pixels (non-zero intensity) per frame
![Intensity](images/Test_intensity_nonbleach.png)

## Correcting individual frames
The median intensity and number of foreground pixels clearly show the frame 4 on the YFP (acceptor) stack is a significant outlier. This can be corroborated with the background subtraction animated video. If there is no experimental justification for this outlier, this frame can be corrected individually by re-running the background subtraction algorithm on frame 4 (donor channel only), with a higher *eps* value, followed by re-running the ratiometric processing module.
```txt
continuous_range = 1:6
manual_frames = 4

window = 40
acceptor_eps = 0.03
donor_eps = 0
```

## Bleach correction
Once all unexpected outliers have been corrected, the bleach correction module can (optionally) be run. The median intensity of the foreground in the donor and acceptor image stacks are used to estimate the range of frames between which the bleaching effect can be fit. The type of fit: linear (regularized) or exponential regression must also be given.
```txt
YFP_bleach_range = 1:6
CFP_bleach_range = 1:6
fit = linear
```
